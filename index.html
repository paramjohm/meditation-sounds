<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Focus Booster Pro - Ultimate Meditation & Productivity Hub</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364; --bg4:#1c2833;
      --text:#ffffff; --muted:#b8fff0; --accent:#00ffcc; --glass:rgba(255,255,255,0.06);
      --shadow:0 0 15px rgba(0,255,204,0.2); --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --reset-btn:#ff6b6b; --reset-hover:#ff5252; --reset-shadow:0 0 15px rgba(255,107,107,0.4);
    }
    [data-theme="light"]{
      --bg1:#e8f7ff; --bg2:#def3ff; --bg3:#d7efff; --bg4:#cfeaff;
      --text:#0b1f2a; --muted:#0b8a78; --accent:#10b981; --glass:rgba(0,0,0,0.05);
      --shadow:0 0 15px rgba(16,185,129,0.2); --success:#059669; --warning:#d97706; --danger:#dc2626;
      --reset-btn:#e53e3e; --reset-hover:#c53030; --reset-shadow:0 0 15px rgba(229,62,62,0.4);
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0; padding: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text); min-height: 100vh;
      display: flex; flex-direction: column; align-items: center; text-align: center;
      overflow-y: auto; overflow-x: hidden;
      background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: 400% 400%; animation: gradientShift 20s ease infinite;
    }
    
    @keyframes gradientShift{
      0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
    }

    /* Background Effects */
    #particles { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    #confetti { position: fixed; inset: 0; z-index: 10; pointer-events: none; }

    .container { padding: 20px; z-index: 2; width: min(1200px, 95vw); flex-grow: 1; }
    
    h1 { 
      font-size: 2.5rem; margin: 0 0 8px; text-shadow: 0 0 20px var(--accent);
      background: linear-gradient(135deg, var(--accent), var(--text));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { font-size: 1.1rem; color: var(--muted); margin-bottom: 25px; font-weight: 500; }

    .card {
      background: var(--glass); box-shadow: var(--shadow); border-radius: 16px; 
      padding: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow), 0 8px 25px rgba(0,0,0,0.15); }

    /* Control Grid */
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .field { display: flex; flex-direction: column; }
    .field label { font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; color: var(--muted); }
    .field input, .field select {
      padding: 12px 15px; border: none; border-radius: 10px; 
      background: rgba(0,0,0,0.2); color: var(--text); outline: none;
      transition: all 0.2s ease; font-size: 0.95rem;
    }
    .field input:focus, .field select:focus {
      background: rgba(0,0,0,0.3); box-shadow: 0 0 0 2px var(--accent);
    }
    [data-theme="light"] .field input, [data-theme="light"] .field select { 
      background: rgba(0,0,0,0.08); 
    }

    .btn {
      padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; 
      font-weight: 700; background: var(--accent); color: #052; font-size: 0.95rem;
      transition: all 0.2s ease; box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      position: relative; overflow: hidden;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .btn:active { transform: translateY(1px); }
    .btn.ghost { background: transparent; border: 2px solid var(--accent); color: var(--text); }
    .btn.success { background: var(--success); color: white; }
    
    /* Enhanced Reset Button Styling */
    .btn.reset { 
      background: linear-gradient(135deg, var(--reset-btn), var(--reset-hover));
      color: white; 
      box-shadow: var(--reset-shadow), 0 6px 20px rgba(0,0,0,0.15);
      border: 2px solid rgba(255,255,255,0.1);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    .btn.reset:before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    .btn.reset:hover {
      background: linear-gradient(135deg, var(--reset-hover), var(--reset-btn));
      box-shadow: var(--reset-shadow), 0 8px 25px rgba(0,0,0,0.2);
      transform: translateY(-2px) scale(1.02);
    }
    .btn.reset:hover:before {
      left: 100%;
    }
    .btn.reset:active {
      transform: translateY(0) scale(0.98);
    }
    
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }

    /* Timer Section - Side by Side Layout */
    .timer-section { 
      display: flex; align-items: center; justify-content: center; 
      gap: 50px; margin: 30px 0; flex-wrap: wrap;
      min-height: 320px;
    }
    
    .timer-container { 
      display: flex; flex-direction: column; align-items: center; 
      flex-shrink: 0; position: relative;
    }
    
    .timer-circle { 
      width: 260px; height: 260px; position: relative;
      background: conic-gradient(from 0deg, var(--accent) 0%, transparent 0%);
      border-radius: 50%; padding: 20px;
      box-shadow: 0 0 40px rgba(0,255,204,0.3), inset 0 0 40px rgba(0,0,0,0.2);
    }
    
    .timer-inner {
      width: 100%; height: 100%; background: var(--bg4); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.3);
    }
    
    .timer-display { 
      font-size: 3rem; font-weight: 800; text-shadow: 0 0 20px var(--accent);
      background: linear-gradient(135deg, var(--accent), var(--text));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    
    .timer-info {
      margin-top: 20px; text-align: center;
    }
    
    .session-counter { 
      font-size: 1.2rem; color: var(--muted); text-shadow: 0 0 10px var(--accent); 
      margin-bottom: 15px; font-weight: 600;
    }
    
    .goal-section h3 { margin: 0 0 10px; font-size: 1rem; color: var(--muted); }
    .goal-dots { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .dot { 
      width: 16px; height: 16px; border-radius: 50%; 
      background: rgba(255,255,255,0.2); transition: all 0.3s ease;
      box-shadow: 0 0 8px var(--accent);
    }
    .dot.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); transform: scale(1.2); }

    /* Meditation Scene - Right Side */
    .meditation-scene { 
      display: flex; flex-direction: column; align-items: center; 
      justify-content: center; flex-shrink: 0;
      padding: 20px; min-height: 280px;
    }

    #userImage {
      max-width: 300px;
      max-height: 300px;
    }
    
    .meditation-avatar { 
      width: 150px; height: 150px; font-size: 120px;
      animation: float 4s ease-in-out infinite, glow 3s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 30px var(--accent));
      background: radial-gradient(circle, rgba(0,255,204,0.1), transparent);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    @keyframes glow { 0% { filter: drop-shadow(0 0 20px var(--accent)); } 100% { filter: drop-shadow(0 0 40px var(--accent)); } }
    
    .meditation-text { 
      margin-top: 20px; font-size: 1.2rem; font-weight: 600; 
      color: var(--accent); text-shadow: 0 0 15px var(--accent);
      text-align: center; max-width: 200px; line-height: 1.4;
    }

    /* Breathing Guide */
    .breath-guide { 
      width: 120px; height: 120px; border-radius: 50%; 
      border: 3px solid var(--accent); margin: 15px auto;
      box-shadow: 0 0 30px var(--accent); opacity: 0.9;
      animation: breathe 6s ease-in-out infinite;
      display: none; position: relative;
    }
    .breath-guide::after {
      content: ''; position: absolute; inset: 10px;
      border-radius: 50%; border: 2px solid var(--accent);
      opacity: 0.5; animation: breathe 6s ease-in-out infinite reverse;
    }
    @keyframes breathe {
      0%, 100% { transform: scale(0.8); opacity: 0.6; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    /* Enhanced Features */
    .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
    
    /* Nature Mixer */
    .nature-mixer h3 { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .mixer-control { 
      display: flex; align-items: center; gap: 15px; margin: 12px 0;
      padding: 8px; border-radius: 8px; transition: background 0.2s ease;
    }
    .mixer-control:hover { background: rgba(255,255,255,0.05); }
    .mixer-control input[type="checkbox"] { transform: scale(1.2); accent-color: var(--accent); }
    .mixer-control input[type="range"] { flex-grow: 1; accent-color: var(--accent); }
    .mixer-control label { font-weight: 600; min-width: 80px; text-align: left; }

    /* Volume Control */
    .volume-control { 
      display: flex; align-items: center; gap: 15px; justify-content: center; 
      margin: 20px 0; padding: 15px; background: var(--glass); border-radius: 12px;
    }
    .volume-control input[type="range"] { width: 200px; accent-color: var(--accent); }

    /* Stats Chart */
    .stats-card canvas { max-height: 300px; }
    
    /* Focus Modes */
    .focus-modes { margin-bottom: 20px; }
    .focus-modes h3 { margin-bottom: 15px; }
    .mode-tabs { 
      display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; 
      background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px;
    }
    .mode-tab { 
      padding: 8px 16px; border: none; background: transparent; 
      color: var(--muted); border-radius: 8px; cursor: pointer;
      transition: all 0.2s ease; font-weight: 600;
    }
    .mode-tab.active { background: var(--accent); color: #052; }
    .mode-tab:hover:not(.active) { background: rgba(255,255,255,0.1); color: var(--text); }

    /* Achievements */
    .achievements { text-align: left; }
    .achievement { 
      display: flex; align-items: center; gap: 15px; 
      padding: 12px; margin: 8px 0; border-radius: 8px;
      background: rgba(255,255,255,0.03); transition: all 0.2s ease;
    }
    .achievement.unlocked { background: rgba(0,255,204,0.1); border-left: 4px solid var(--accent); }
    .achievement-icon { font-size: 1.5rem; }
    .achievement-info h4 { margin: 0; font-size: 0.9rem; }
    .achievement-info p { margin: 0; font-size: 0.8rem; color: var(--muted); }

    /* Toasts */
    #toasts { position: fixed; right: 20px; top: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 15; }
    .toast {
      background: var(--glass); color: var(--text); border-left: 6px solid var(--accent); 
      padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow);
      animation: slideIn 0.3s ease; backdrop-filter: blur(10px); 
      min-width: 280px; text-align: left; font-weight: 600;
    }
    @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* YouTube Player Styles */
    .youtube-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .youtube-player {
      width: 100%;
      max-width: 300px;
      height: 200px;
      border-radius: 12px;
      border: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .timer-section { gap: 30px; flex-direction: column; }
      .timer-circle { width: 220px; height: 220px; }
      .timer-display { font-size: 2.5rem; }
      .meditation-avatar { width: 120px; height: 120px; font-size: 90px; }
      .feature-grid { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
    }

    .hidden { display: none !important; }
    
    /* Theme toggle button */
    .theme-toggle { 
      position: fixed; top: 20px; right: 20px; z-index: 20;
      width: 50px; height: 50px; border-radius: 50%;
      border: 2px solid var(--accent); background: var(--glass);
      color: var(--text); cursor: pointer; font-size: 1.2rem;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px); transition: all 0.3s ease;
    }
    .theme-toggle:hover { transform: scale(1.1); box-shadow: var(--shadow); }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>
  <canvas id="confetti"></canvas>
  <div id="toasts"></div>
  
  <button class="theme-toggle" id="themeToggle" title="Toggle Theme">üåô</button>

  <div class="container">
    <h1>üßò‚Äç‚ôÄÔ∏è Focus Booster Pro</h1>
    <p class="subtitle">Ultimate Meditation & Productivity Hub with Advanced Features</p>

    <!-- Main Controls -->
    <div class="card">
      <div class="focus-modes">
        <h3>Focus Modes</h3>
        <div class="mode-tabs">
          <button class="mode-tab active" data-mode="pomodoro">üçÖ Pomodoro</button>
          <button class="mode-tab" data-mode="deep">üéØ Deep Focus</button>
          <button class="mode-tab" data-mode="meditation">üßò Meditation</button>
          <button class="mode-tab" data-mode="custom">‚öôÔ∏è Custom</button>
        </div>
      </div>

      <div class="controls">
        <div class="field">
          <label>Focus Time (minutes)</label>
          <input type="number" id="focusTime" value="25" min="1" max="180">
        </div>
        <div class="field">
          <label>Short Break (minutes)</label>
          <input type="number" id="breakTime" value="5" min="1" max="60">
        </div>
        <div class="field">
          <label>Long Break Every</label>
          <input type="number" id="longBreakEvery" value="4" min="2" max="12">
        </div>
        <div class="field">
          <label>Long Break Length (minutes)</label>
          <input type="number" id="longBreakMinutes" value="15" min="5" max="60">
        </div>
        <div class="field">
          <label>Daily Goal (sessions)</label>
          <input type="number" id="goalSessions" value="4" min="1" max="16">
        </div>
        <div class="field">
          <label>Background Music</label>
          <select id="musicSelect">
            <option value="">üîá None</option>
            <option value="https://drive.google.com/uc?export=download&id=1YHgsbE1ZDwjcHvu_Rgau9a7T2Hb1RvY0">üåä Ocean Waves</option>
            <option value="focus">üéµ Deep Focus</option>
            <option value="zen">üïâÔ∏è Zen Meditation</option>
            <option value="youtube">üì∫ YouTube Link</option>
          </select>
        </div>
        <div class="field">
          <label>YouTube Link (Optional)</label>
          <input type="text" id="youtubeLink" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="field">
          <label>Auto-start Breaks</label>
          <select id="autoBreaks">
            <option value="true">‚úÖ Yes</option>
            <option value="false">‚ùå No</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button id="startBtn" class="btn success">‚ñ∂Ô∏è Start Focus</button>
        <button id="pauseBtn" class="btn ghost">‚è∏Ô∏è Pause</button>
        <button id="resetBtn" class="btn reset">üîÑ Reset</button>
        <button id="skipBtn" class="btn ghost">‚è≠Ô∏è Skip</button>
      </div>

      <div class="volume-control">
        <label><strong>üîä Master Volume</strong></label>
        <input type="range" id="volumeSlider" min="0" max="100" value="70">
        <span id="volumeDisplay">70%</span>
      </div>

      <!-- YouTube Player Container -->
      <div id="youtubeContainer" class="youtube-container hidden">
        <iframe id="youtubePlayer" class="youtube-player" allowfullscreen></iframe>
      </div>
    </div>

    <!-- Timer and Meditation Scene - Side by Side -->
    <div class="timer-section">
      <div class="timer-container">
        <div class="timer-circle" id="timerCircle">
          <div class="timer-inner">
            <div class="timer-display" id="timerDisplay">25:00</div>
          </div>
        </div>
        <div class="timer-info">
          <div class="session-counter" id="sessionCounter">Session: 0</div>
          <div class="goal-section">
            <h3>Daily Progress</h3>
            <div class="goal-dots" id="goalDots"></div>
          </div>
          <div class="breath-guide" id="breathGuide"></div>
        </div>
      </div>

     <div class="meditation-scene">
        <div class="meditation-avatar" id="meditationAvatar">
          <img id="userImage" src="https://i.postimg.cc/7Z42wQs7/Chat-GPT-Image-Aug-18-2025-04-11-32-PM-1.png" alt="Your meditation image" style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%;">
        </div>
        <div class="meditation-text" id="meditationText">Find your center, breathe deeply</div>
      </div>
    </div>

    <!-- Enhanced Features Grid -->
    <div class="feature-grid">
      <!-- Nature Sound Mixer -->
      <div class="card nature-mixer">
        <h3>üåø Nature Sound Mixer</h3>
        <div class="mixer-control">
          <input type="checkbox" class="mix-toggle" data-id="rain" id="rainToggle">
          <label for="rainToggle">üåßÔ∏è Rain</label>
          <input type="range" min="0" max="100" value="50" class="mix-vol" data-id="rain">
        </div>
        <div class="mixer-control">
          <input type="checkbox" class="mix-toggle" data-id="forest" id="forestToggle">
          <label for="forestToggle">üå≤ Forest</label>
          <input type="range" min="0" max="100" value="50" class="mix-vol" data-id="forest">
        </div>
        <div class="mixer-control">
          <input type="checkbox" class="mix-toggle" data-id="fire" id="fireToggle">
          <label for="fireToggle">üî• Fireplace</label>
          <input type="range" min="0" max="100" value="50" class="mix-vol" data-id="fire">
        </div>
        <div class="mixer-control">
          <input type="checkbox" class="mix-toggle" data-id="ocean" id="oceanToggle">
          <label for="oceanToggle">üåä Ocean</label>
          <input type="range" min="0" max="100" value="50" class="mix-vol" data-id="ocean">
        </div>
        <div class="mixer-control">
          <input type="checkbox" class="mix-toggle" data-id="wind" id="windToggle">
          <label for="windToggle">üí® Wind</label>
          <input type="range" min="0" max="100" value="50" class="mix-vol" data-id="wind">
        </div>
      </div>

      <!-- Weekly Stats -->
      <div class="card stats-card">
        <h3>üìä Weekly Focus Stats</h3>
        <canvas id="weeklyChart"></canvas>
        <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 0.9rem;">
          <span>üìà Streak: <strong id="streakCount">0</strong> days</span>
          <span>‚è±Ô∏è Total: <strong id="totalTime">0h 0m</strong></span>
        </div>
      </div>

      <!-- Achievements -->
      <div class="card achievements">
        <h3>üèÜ Achievements</h3>
        <div id="achievementsList">
          <div class="achievement" data-achievement="first">
            <div class="achievement-icon">üéØ</div>
            <div class="achievement-info">
              <h4>First Focus</h4>
              <p>Complete your first session</p>
            </div>
          </div>
          <div class="achievement" data-achievement="streak3">
            <div class="achievement-icon">üî•</div>
            <div class="achievement-info">
              <h4>On Fire</h4>
              <p>3 day focus streak</p>
            </div>
          </div>
          <div class="achievement" data-achievement="goal">
            <div class="achievement-icon">‚ú®</div>
            <div class="achievement-info">
              <h4>Goal Crusher</h4>
              <p>Reach daily goal</p>
            </div>
          </div>
          <div class="achievement" data-achievement="marathon">
            <div class="achievement-icon">üèÉ‚Äç‚ôÄÔ∏è</div>
            <div class="achievement-info">
              <h4>Marathon</h4>
              <p>60+ minute session</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== STATE MANAGEMENT ==========
    let timer = null;
    let totalSeconds = 0;
    let currentMode = 'pomodoro';
    let isBreak = false;
    let isPaused = false;
    let isRunning = false;
    let sessionCount = 0;
    let completedToday = 0;
    let currentStreak = 0;
    let focusMinutes = 25;
    let breakMinutes = 5;
    let longEvery = 4;
    let longMinutes = 15;
    let goalCount = 4;
    let startTime = null;
    let totalFocusTime = 0;

    // Audio context for nature sounds
    let audioContext = null;
    let natureSounds = {};
    let currentBackgroundMusic = null;

    // DOM Elements
    const timerDisplay = document.getElementById('timerDisplay');
    const timerCircle = document.getElementById('timerCircle');
    const sessionCounter = document.getElementById('sessionCounter');
    const goalDots = document.getElementById('goalDots');
    const breathGuide = document.getElementById('breathGuide');
    const meditationText = document.getElementById('meditationText');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const skipBtn = document.getElementById('skipBtn');
    const themeToggle = document.getElementById('themeToggle');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeDisplay = document.getElementById('volumeDisplay');
    const youtubeContainer = document.getElementById('youtubeContainer');
    const youtubePlayer = document.getElementById('youtubePlayer');

    // ========== MOTIVATIONAL CONTENT ==========
    const FOCUS_QUOTES = [
      "Deep work produces better results than shallow work.",
      "Focus is the ultimate superpower in our distracted world.",
      "Quality over quantity. Make every minute count.",
      "Your attention is your most valuable resource.",
      "Progress, not perfection. Keep going!",
      "The way to get started is to quit talking and begin doing.",
      "Success is the sum of small efforts repeated daily."
    ];

    const BREAK_QUOTES = [
      "Rest is not idleness. Recharge your mind.",
      "A rested mind is a creative mind.",
      "Breathe deeply. You're making progress.",
      "Small breaks lead to big breakthroughs.",
      "Pause. Reflect. Continue with purpose.",
      "Your brain needs rest to consolidate learning.",
      "Taking breaks improves focus and productivity."
    ];

    const MEDITATION_MANTRAS = [
      "Breathe in calm, breathe out tension.",
      "Present moment, wonderful moment.",
      "I am focused and at peace.",
      "Each breath brings me clarity.",
      "Stillness is the path to insight.",
      "Mind like water, clear and calm.",
      "In this moment, I am complete."
    ];

    // ========== FOCUS MODES ==========
    const FOCUS_MODES = {
      pomodoro: { focus: 25, shortBreak: 5, longBreak: 15, longEvery: 4 },
      deep: { focus: 90, shortBreak: 15, longBreak: 30, longEvery: 2 },
      meditation: { focus: 10, shortBreak: 2, longBreak: 5, longEvery: 3 },
      custom: { focus: 25, shortBreak: 5, longBreak: 15, longEvery: 4 }
    };

    // ========== NATURE SOUNDS DATA ==========
    const NATURE_SOUNDS = {
      rain: 'https://www.soundjay.com/misc/sounds/rain-01.wav',
      forest: 'https://www.soundjay.com/nature/sounds/forest-birds.wav',
      fire: 'https://www.soundjay.com/misc/sounds/fireplace.wav',
      ocean: 'https://www.soundjay.com/misc/sounds/ocean-waves.wav',
      wind: 'https://www.soundjay.com/nature/sounds/wind.wav'
    };

    // ========== BACKGROUND PARTICLES ==========
    const pCanvas = document.getElementById('particles');
    const pCtx = pCanvas.getContext('2d');
    let particles = [];

    function initParticles() {
      pCanvas.width = window.innerWidth;
      pCanvas.height = window.innerHeight;
      particles = [];
      
      for (let i = 0; i < 60; i++) {
        particles.push({
          x: Math.random() * pCanvas.width,
          y: Math.random() * pCanvas.height,
          vx: (Math.random() - 0.5) * 0.4,
          vy: (Math.random() - 0.5) * 0.4,
          radius: Math.random() * 2 + 0.5,
          opacity: Math.random() * 0.6 + 0.2
        });
      }
    }

    function animateParticles() {
      pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
      
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        
        if (p.x < 0 || p.x > pCanvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > pCanvas.height) p.vy *= -1;
        
        pCtx.globalAlpha = p.opacity;
        pCtx.fillStyle = 'rgba(0, 255, 204, 0.4)';
        pCtx.beginPath();
        pCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        pCtx.fill();
      });
      
      requestAnimationFrame(animateParticles);
    }

    window.addEventListener('resize', initParticles);
    initParticles();
    animateParticles();

    // ========== CONFETTI SYSTEM ==========
    const cCanvas = document.getElementById('confetti');
    const cCtx = cCanvas.getContext('2d');
    cCanvas.width = window.innerWidth;
    cCanvas.height = window.innerHeight;

    function confettiBurst() {
      const pieces = [];
      for (let i = 0; i < 200; i++) {
        pieces.push({
          x: cCanvas.width / 2,
          y: cCanvas.height / 3,
          vx: (Math.random() - 0.5) * 8,
          vy: Math.random() * -8 - 3,
          size: Math.random() * 8 + 4,
          rotation: Math.random() * Math.PI,
          rotationSpeed: (Math.random() - 0.5) * 0.3,
          color: `hsl(${Math.random() * 360}, 90%, 60%)`,
          life: 150 + Math.random() * 100
        });
      }

      function animateConfetti() {
        cCtx.clearRect(0, 0, cCanvas.width, cCanvas.height);
        
        pieces.forEach((p, index) => {
          p.vy += 0.15;
          p.x += p.vx;
          p.y += p.vy;
          p.rotation += p.rotationSpeed;
          p.life--;

          cCtx.save();
          cCtx.translate(p.x, p.y);
          cCtx.rotate(p.rotation);
          cCtx.fillStyle = p.color;
          cCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          cCtx.restore();

          if (p.life <= 0 || p.y > cCanvas.height) {
            pieces.splice(index, 1);
          }
        });

        if (pieces.length > 0) {
          requestAnimationFrame(animateConfetti);
        }
      }
      animateConfetti();
    }

    // ========== TOAST NOTIFICATIONS ==========
    function showToast(message, type = 'info') {
      const toasts = document.getElementById('toasts');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      toasts.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
      }, 3000);
      
      setTimeout(() => {
        if (toast.parentNode) {
          toasts.removeChild(toast);
        }
      }, 3500);
    }

    // ========== UTILITY FUNCTIONS ==========
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimerCircle() {
      const total = isBreak ? (currentBreakLength() * 60) : (focusMinutes * 60);
      const progress = Math.max(0, (total - totalSeconds) / total);
      const degree = progress * 360;
      
      timerCircle.style.background = `conic-gradient(from 0deg, var(--accent) ${degree}deg, transparent ${degree}deg)`;
    }

    function currentBreakLength() {
      return (sessionCount > 0 && sessionCount % longEvery === 0) ? longMinutes : breakMinutes;
    }

    function updateSessionDisplay() {
      sessionCounter.textContent = `Session: ${sessionCount}`;
      updateGoalDots();
    }

    function updateGoalDots() {
      goalDots.innerHTML = '';
      for (let i = 1; i <= goalCount; i++) {
        const dot = document.createElement('div');
        dot.className = `dot ${i <= sessionCount ? 'active' : ''}`;
        goalDots.appendChild(dot);
      }
    }

    // ========== ENHANCED AUDIO MANAGEMENT ==========
    function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Initialize nature sounds with Web Audio API fallback
        Object.keys(NATURE_SOUNDS).forEach(soundName => {
          const audio = document.createElement('audio');
          audio.id = soundName;
          audio.loop = true;
          audio.crossOrigin = 'anonymous';
          
          // Create fallback oscillator for nature sounds
          natureSounds[soundName] = {
            audio: audio,
            oscillator: null,
            gainNode: audioContext.createGain(),
            isPlaying: false
          };
          
          natureSounds[soundName].gainNode.connect(audioContext.destination);
          natureSounds[soundName].gainNode.gain.value = 0;
          
          document.body.appendChild(audio);
        });
        
        // Create actual nature sound generators
        createNatureSoundGenerators();
        
      } catch (error) {
        console.log('Web Audio API not supported, using HTML5 audio fallback');
      }
    }

    function createNatureSoundGenerators() {
      if (!audioContext) return;
      
      Object.keys(natureSounds).forEach(soundName => {
        const sound = natureSounds[soundName];
        
        // Create different types of noise for each sound
        switch (soundName) {
          case 'rain':
            sound.oscillator = createWhiteNoise();
            break;
          case 'ocean':
            sound.oscillator = createOceanWave();
            break;
          case 'forest':
            sound.oscillator = createForestAmbient();
            break;
          case 'fire':
            sound.oscillator = createFireCrackle();
            break;
          case 'wind':
            sound.oscillator = createWindNoise();
            break;
        }
        
        if (sound.oscillator) {
          sound.oscillator.connect(sound.gainNode);
          sound.oscillator.start();
        }
      });
    }

    function createWhiteNoise() {
      const bufferSize = 2 * audioContext.sampleRate;
      const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      const whiteNoise = audioContext.createBufferSource();
      whiteNoise.buffer = noiseBuffer;
      whiteNoise.loop = true;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.value = 400;
      filter.Q.value = 1;
      
      whiteNoise.connect(filter);
      return filter;
    }

    function createOceanWave() {
      const oscillator = audioContext.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.value = 0.1;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 0.3;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 200;
      
      oscillator.connect(gainNode);
      gainNode.connect(filter);
      return filter;
    }

    function createForestAmbient() {
      const oscillator = audioContext.createOscillator();
      oscillator.type = 'sawtooth';
      oscillator.frequency.value = 100;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 800;
      filter.Q.value = 0.5;
      
      oscillator.connect(filter);
      return filter;
    }

    function createFireCrackle() {
      const bufferSize = 2 * audioContext.sampleRate;
      const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        output[i] = (Math.random() * 2 - 1) * Math.sin(i * 0.001);
      }
      
      const crackle = audioContext.createBufferSource();
      crackle.buffer = noiseBuffer;
      crackle.loop = true;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.value = 1200;
      filter.Q.value = 2;
      
      crackle.connect(filter);
      return filter;
    }

    function createWindNoise() {
      const bufferSize = 2 * audioContext.sampleRate;
      const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      const windNoise = audioContext.createBufferSource();
      windNoise.buffer = noiseBuffer;
      windNoise.loop = true;
      
      const filter = audioContext.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 600;
      filter.Q.value = 0.8;
      
      windNoise.connect(filter);
      return filter;
    }

    function toggleNatureSound(soundName, isEnabled, volume = 0.5) {
      if (!natureSounds[soundName]) return;
      
      const sound = natureSounds[soundName];
      const targetVolume = isEnabled ? volume * (volumeSlider.value / 100) : 0;
      
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      // Smooth volume transition
      if (sound.gainNode) {
        sound.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
        sound.gainNode.gain.setValueAtTime(sound.gainNode.gain.value, audioContext.currentTime);
        sound.gainNode.gain.linearRampToValueAtTime(targetVolume, audioContext.currentTime + 0.5);
      }
      
      sound.isPlaying = isEnabled;
    }

    function stopAllNatureSounds() {
      Object.keys(natureSounds).forEach(soundName => {
        toggleNatureSound(soundName, false);
        const checkbox = document.querySelector(`.mix-toggle[data-id="${soundName}"]`);
        if (checkbox) checkbox.checked = false;
      });
    }

    function playBackgroundMusic(choice) {
      stopBackgroundMusic();
      
      if (!choice) return;
      
      if (choice === 'youtube') {
        const url = document.getElementById('youtubeLink').value.trim();
        const videoId = extractYouTubeId(url);
        
        if (!videoId) {
          showToast('‚ùå Please enter a valid YouTube URL', 'error');
          return;
        }
        
        youtubePlayer.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&controls=1`;
        youtubeContainer.classList.remove('hidden');
        currentBackgroundMusic = 'youtube';
        
        showToast('üéµ YouTube music loaded!', 'success');
      } else {
        // Create audio element for background music
        const audio = document.createElement('audio');
        audio.loop = true;
        audio.volume = volumeSlider.value / 100;
        
        // Use synthetic audio for demo
        playBuiltInMusic(choice);
        currentBackgroundMusic = choice;
      }
    }

    function playBuiltInMusic(type) {
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      switch (type) {
        case 'calm':
          oscillator.frequency.value = 200;
          oscillator.type = 'sine';
          break;
        case 'focus':
          oscillator.frequency.value = 300;
          oscillator.type = 'triangle';
          break;
        case 'zen':
          oscillator.frequency.value = 150;
          oscillator.type = 'sine';
          break;
      }
      
      gainNode.gain.value = (volumeSlider.value / 100) * 0.1;
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      oscillator.start();
      
      // Store reference for cleanup
      currentBackgroundMusic = { oscillator, gainNode };
      
      showToast(`üéµ Playing ${type} music`, 'success');
    }

    function stopBackgroundMusic() {
      if (currentBackgroundMusic) {
        if (typeof currentBackgroundMusic === 'object' && currentBackgroundMusic.oscillator) {
          try {
            currentBackgroundMusic.oscillator.stop();
          } catch (e) {
            // Oscillator already stopped
          }
        }
        
        youtubeContainer.classList.add('hidden');
        youtubePlayer.src = '';
        currentBackgroundMusic = null;
      }
    }

    function extractYouTubeId(url) {
      const patterns = [
        /(?:youtube\.com.*(?:\?|&)v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
      }
      
      return null;
    }

    // ========== NATURE SOUND MIXER ==========
    function initNatureMixer() {
      document.querySelectorAll('.mix-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const audioId = this.dataset.id;
          const volumeSlider = document.querySelector(`.mix-vol[data-id="${audioId}"]`);
          
          if (this.checked) {
            toggleNatureSound(audioId, true, volumeSlider.value / 100);
            showToast(`üîä ${audioId.charAt(0).toUpperCase() + audioId.slice(1)} sound enabled`, 'success');
          } else {
            toggleNatureSound(audioId, false);
            showToast(`üîá ${audioId.charAt(0).toUpperCase() + audioId.slice(1)} sound disabled`, 'info');
          }
        });
      });

      document.querySelectorAll('.mix-vol').forEach(slider => {
        slider.addEventListener('input', function() {
          const audioId = this.dataset.id;
          const checkbox = document.querySelector(`.mix-toggle[data-id="${audioId}"]`);
          
          if (checkbox.checked) {
            toggleNatureSound(audioId, true, this.value / 100);
          }
        });
      });
    }

    // ========== FOCUS MODES ==========
    function initFocusModes() {
      document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          currentMode = this.dataset.mode;
          applyFocusMode(currentMode);
          showToast(`üéØ Switched to ${this.textContent} mode`, 'success');
        });
      });
    }

    function applyFocusMode(mode) {
      const settings = FOCUS_MODES[mode];
      if (!settings) return;

      document.getElementById('focusTime').value = settings.focus;
      document.getElementById('breakTime').value = settings.shortBreak;
      document.getElementById('longBreakMinutes').value = settings.longBreak;
      document.getElementById('longBreakEvery').value = settings.longEvery;

      focusMinutes = settings.focus;
      breakMinutes = settings.shortBreak;
      longMinutes = settings.longBreak;
      longEvery = settings.longEvery;

      if (!isRunning) {
        totalSeconds = focusMinutes * 60;
        timerDisplay.textContent = formatTime(totalSeconds);
        updateTimerCircle();
      }
    }

    // ========== IMPROVED TIMER CORE ==========
    function startTimer() {
      // Resume audio context if suspended
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      if (isPaused) {
        // Resuming from pause
        isPaused = false;
        pauseBtn.textContent = '‚è∏Ô∏è Pause';
        showToast('‚ñ∂Ô∏è Timer resumed', 'success');
      } else {
        // Fresh start or restart
        if (isRunning) {
          // This is a restart
          clearInterval(timer);
          stopBackgroundMusic();
          stopAllNatureSounds();
        }
        
        readInputs();
        totalSeconds = isBreak ? (currentBreakLength() * 60) : (focusMinutes * 60);
        
        if (!isBreak) {
          startTime = Date.now();
        }
        
        // Reset button states
        startBtn.textContent = 'üîÑ Restart';
        pauseBtn.textContent = '‚è∏Ô∏è Pause';
      }

      isRunning = true;
      playBackgroundMusic(document.getElementById('musicSelect').value);
      updateMeditationText();
      
      timer = setInterval(runTimer, 1000);
      
      if (!isPaused) {
        const sessionType = isBreak ? 'break' : 'focus';
        showToast(`üéØ ${sessionType.charAt(0).toUpperCase() + sessionType.slice(1)} session started!`, 'success');
      }
    }

    function runTimer() {
      if (isPaused) return;

      timerDisplay.textContent = formatTime(totalSeconds);
      updateTimerCircle();

      if (totalSeconds <= 0) {
        clearInterval(timer);
        handleTimerComplete();
        return;
      }

      totalSeconds--;
    }

    function handleTimerComplete() {
      if (!isBreak) {
        // Focus session completed
        sessionCount++;
        completedToday++;
        
        const focusTime = Math.floor((Date.now() - startTime) / 1000 / 60);
        totalFocusTime += focusTime;
        
        updateSessionDisplay();
        saveProgress();
        updateChart();
        checkAchievements();

        if (sessionCount >= goalCount) {
          showToast('üéâ Daily goal achieved! Amazing work!', 'success');
          confettiBurst();
        } else {
          showToast(`‚úÖ Focus session ${sessionCount} completed!`, 'success');
        }

        // Start break
        const breakLength = currentBreakLength();
        totalSeconds = breakLength * 60;
        isBreak = true;
        
        // Show breathing guide during break
        breathGuide.style.display = 'block';
        updateMeditationText();
        
        showToast(`üòå ${breakLength === longMinutes ? 'Long' : 'Short'} break started (${breakLength} min)`, 'info');
        
        // Auto-start break if enabled
        if (document.getElementById('autoBreaks').value === 'true') {
          timer = setInterval(runTimer, 1000);
          startBtn.textContent = 'üîÑ Restart';
        } else {
          isRunning = false;
          startBtn.textContent = '‚ñ∂Ô∏è Start Break';
          stopBackgroundMusic();
        }
      } else {
        // Break completed
        showToast('‚è∞ Break over! Ready for next session?', 'info');
        breathGuide.style.display = 'none';
        
        totalSeconds = focusMinutes * 60;
        isBreak = false;
        isRunning = false;
        updateMeditationText();
        
        startBtn.textContent = '‚ñ∂Ô∏è Start Focus';
        stopBackgroundMusic();
        stopAllNatureSounds();
      }
    }

    function pauseTimer() {
      if (!isRunning) return;
      
      isPaused = !isPaused;
      
      if (isPaused) {
        clearInterval(timer);
        pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
        showToast('‚è∏Ô∏è Timer paused', 'info');
        stopBackgroundMusic();
        stopAllNatureSounds();
      } else {
        startTimer(); // This will resume the timer
      }
    }

    function resetTimer() {
      // Clear any existing timer
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      
      // Reset all states
      isPaused = false;
      isRunning = false;
      isBreak = false;
      
      // Stop all audio
      stopBackgroundMusic();
      stopAllNatureSounds();
      
      // Reset timer values
      readInputs();
      totalSeconds = focusMinutes * 60;
      
      // Update display
      timerDisplay.textContent = formatTime(totalSeconds);
      updateTimerCircle();
      updateMeditationText();
      
      // Hide breathing guide
      breathGuide.style.display = 'none';
      
      // Reset button states
      startBtn.textContent = '‚ñ∂Ô∏è Start Focus';
      pauseBtn.textContent = '‚è∏Ô∏è Pause';
      
      showToast('üîÑ Timer reset successfully', 'success');
    }

    function skipSession() {
      if (!isRunning && !isPaused) {
        showToast('‚ö†Ô∏è No active session to skip', 'warning');
        return;
      }
      
      clearInterval(timer);
      totalSeconds = 0;
      
      // Force completion of current session
      handleTimerComplete();
      
      showToast('‚è≠Ô∏è Session skipped', 'info');
    }

    function readInputs() {
      focusMinutes = parseInt(document.getElementById('focusTime').value) || 25;
      breakMinutes = parseInt(document.getElementById('breakTime').value) || 5;
      longMinutes = parseInt(document.getElementById('longBreakMinutes').value) || 15;
      longEvery = parseInt(document.getElementById('longBreakEvery').value) || 4;
      goalCount = parseInt(document.getElementById('goalSessions').value) || 4;
      
      updateGoalDots();
    }

    function updateMeditationText() {
      const textElement = document.getElementById('meditationText');
      let newText;
      
      if (!isRunning && !isPaused) {
        newText = MEDITATION_MANTRAS[Math.floor(Math.random() * MEDITATION_MANTRAS.length)];
      } else if (isBreak) {
        newText = BREAK_QUOTES[Math.floor(Math.random() * BREAK_QUOTES.length)];
      } else {
        newText = FOCUS_QUOTES[Math.floor(Math.random() * FOCUS_QUOTES.length)];
      }
      
      textElement.style.opacity = '0';
      setTimeout(() => {
        textElement.textContent = newText;
        textElement.style.opacity = '1';
      }, 300);
    }

    // ========== ACHIEVEMENTS SYSTEM ==========
    const ACHIEVEMENTS = {
      first: { name: 'First Focus', description: 'Complete your first session', condition: () => sessionCount >= 1 },
      streak3: { name: 'On Fire', description: '3 day focus streak', condition: () => currentStreak >= 3 },
      goal: { name: 'Goal Crusher', description: 'Reach daily goal', condition: () => sessionCount >= goalCount },
      marathon: { name: 'Marathon', description: '60+ minute session', condition: () => focusMinutes >= 60 }
    };

    function checkAchievements() {
      Object.keys(ACHIEVEMENTS).forEach(key => {
        const achievement = ACHIEVEMENTS[key];
        const element = document.querySelector(`[data-achievement="${key}"]`);
        
        if (achievement.condition() && !element.classList.contains('unlocked')) {
          element.classList.add('unlocked');
          showToast(`üèÜ Achievement unlocked: ${achievement.name}!`, 'success');
          confettiBurst();
          saveAchievement(key);
        }
      });
    }

    function saveAchievement(achievementKey) {
      try {
        const achievements = JSON.parse(localStorage.getItem('focusBoosterAchievements') || '[]');
        if (!achievements.includes(achievementKey)) {
          achievements.push(achievementKey);
          localStorage.setItem('focusBoosterAchievements', JSON.stringify(achievements));
        }
      } catch (error) {
        console.log('LocalStorage not available for achievements');
      }
    }

    function loadAchievements() {
      try {
        const achievements = JSON.parse(localStorage.getItem('focusBoosterAchievements') || '[]');
        achievements.forEach(key => {
          const element = document.querySelector(`[data-achievement="${key}"]`);
          if (element) {
            element.classList.add('unlocked');
          }
        });
      } catch (error) {
        console.log('LocalStorage not available for loading achievements');
      }
    }

    // ========== DATA PERSISTENCE ==========
    function getTodayKey() {
      const date = new Date();
      return `focusBooster_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function saveProgress() {
      try {
        const todayKey = getTodayKey();
        const data = {
          sessions: completedToday,
          focusTime: totalFocusTime,
          date: new Date().toDateString()
        };
        
        localStorage.setItem(todayKey, JSON.stringify(data));
        updateStreak();
      } catch (error) {
        console.log('LocalStorage not available for saving progress');
      }
    }

    function loadTodayProgress() {
      try {
        const todayKey = getTodayKey();
        const data = JSON.parse(localStorage.getItem(todayKey) || '{}');
        
        completedToday = data.sessions || 0;
        totalFocusTime = data.focusTime || 0;
        sessionCount = completedToday;
        
        updateSessionDisplay();
      } catch (error) {
        console.log('LocalStorage not available for loading progress');
      }
    }

    function updateStreak() {
      let streak = 0;
      const today = new Date();
      
      try {
        for (let i = 0; i < 30; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          
          const key = `focusBooster_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          
          if (data.sessions > 0) {
            streak = i + 1;
          } else {
            break;
          }
        }
      } catch (error) {
        console.log('LocalStorage not available for streak calculation');
      }
      
      currentStreak = streak;
      document.getElementById('streakCount').textContent = streak;
    }

    // ========== STATS CHART ==========
    let statsChart;

    function initChart() {
      const ctx = document.getElementById('weeklyChart').getContext('2d');
      const data = getLast7Days();
      
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Focus Sessions',
            data: data.sessions,
            backgroundColor: 'rgba(0, 255, 204, 0.7)',
            borderColor: 'rgba(0, 255, 204, 1)',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                precision: 0,
                color: 'rgba(255, 255, 255, 0.7)'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: { 
                color: 'rgba(255, 255, 255, 0.7)'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
    }

    function getLast7Days() {
      const labels = [];
      const sessions = [];
      
      try {
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          
          const key = `focusBooster_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          
          labels.push(date.toLocaleDateString('en', { weekday: 'short' }));
          sessions.push(data.sessions || 0);
        }
      } catch (error) {
        console.log('LocalStorage not available for chart data');
        // Provide fallback data
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('en', { weekday: 'short' }));
          sessions.push(0);
        }
      }
      
      return { labels, sessions };
    }

    function updateChart() {
      if (!statsChart) return;
      
      const data = getLast7Days();
      statsChart.data.labels = data.labels;
      statsChart.data.datasets[0].data = data.sessions;
      statsChart.update();
      
      // Update total time display
      const hours = Math.floor(totalFocusTime / 60);
      const minutes = totalFocusTime % 60;
      document.getElementById('totalTime').textContent = `${hours}h ${minutes}m`;
    }

    // ========== THEME SYSTEM ==========
    function initTheme() {
      try {
        const savedTheme = localStorage.getItem('focusBoosterTheme') || 'dark';
        applyTheme(savedTheme);
      } catch (error) {
        applyTheme('dark');
      }
      
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
      });
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      try {
        localStorage.setItem('focusBoosterTheme', theme);
      } catch (error) {
        console.log('LocalStorage not available for theme');
      }
      themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // ========== VOLUME CONTROL ==========
    function initVolumeControl() {
      volumeSlider.addEventListener('input', () => {
        const volume = volumeSlider.value;
        volumeDisplay.textContent = volume + '%';
        
        // Update nature sounds volume
        Object.keys(natureSounds).forEach(soundName => {
          const sound = natureSounds[soundName];
          const checkbox = document.querySelector(`.mix-toggle[data-id="${soundName}"]`);
          const mixSlider = document.querySelector(`.mix-vol[data-id="${soundName}"]`);
          
          if (checkbox && checkbox.checked && mixSlider && sound.gainNode) {
            const targetVolume = (mixSlider.value / 100) * (volume / 100);
            sound.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
            sound.gainNode.gain.setValueAtTime(sound.gainNode.gain.value, audioContext.currentTime);
            sound.gainNode.gain.linearRampToValueAtTime(targetVolume, audioContext.currentTime + 0.1);
          }
        });

        // Update background music volume
        if (currentBackgroundMusic && typeof currentBackgroundMusic === 'object' && currentBackgroundMusic.gainNode) {
          currentBackgroundMusic.gainNode.gain.value = (volume / 100) * 0.1;
        }
      });
    }

    // ========== EVENT LISTENERS ==========
    function initEventListeners() {
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      skipBtn.addEventListener('click', skipSession);
      
      // Input change listeners
      document.getElementById('goalSessions').addEventListener('change', () => {
        readInputs();
        updateGoalDots();
      });

      // Music selection listener
      document.getElementById('musicSelect').addEventListener('change', () => {
        if (isRunning) {
          playBackgroundMusic(document.getElementById('musicSelect').value);
        }
      });

      // YouTube link validation
      document.getElementById('youtubeLink').addEventListener('input', (e) => {
        const url = e.target.value.trim();
        if (url && !extractYouTubeId(url)) {
          e.target.style.borderColor = 'var(--danger)';
        } else {
          e.target.style.borderColor = '';
        }
      });

      // Update meditation text periodically
      setInterval(updateMeditationText, 30000);

      // Handle page visibility
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Reduce performance when tab is hidden
          if (!isRunning) {
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
          }
        } else {
          // Resume animations when tab is visible
          if (!document.hidden) {
            animateParticles();
          }
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return; // Don't trigger when typing
        
        switch (e.key.toLowerCase()) {
          case ' ': // Spacebar
            e.preventDefault();
            if (isRunning) {
              pauseTimer();
            } else {
              startTimer();
            }
            break;
          case 'r':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              resetTimer();
            }
            break;
          case 's':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              skipSession();
            }
            break;
        }
      });
    }

    // ========== INITIALIZATION ==========
    function init() {
      // Initialize core systems
      initAudio();
      initTheme();
      initVolumeControl();
      initFocusModes();
      initNatureMixer();
      initEventListeners();
      
      // Load saved data
      loadTodayProgress();
      loadAchievements();
      updateStreak();
      
      // Initialize chart
      initChart();
      
      // Set initial timer state
      readInputs();
      totalSeconds = focusMinutes * 60;
      timerDisplay.textContent = formatTime(totalSeconds);
      updateTimerCircle();
      updateMeditationText();
      
      // Welcome message
      showToast('üßò‚Äç‚ôÄÔ∏è Focus Booster Pro is ready! Press SPACE to start or click buttons.', 'success');
      
      // Show keyboard shortcuts after a delay
      setTimeout(() => {
        showToast('üí° Tip: Use SPACE to start/pause, CTRL+R to reset, CTRL+S to skip', 'info');
      }, 5000);
    }

    // ========== START THE APPLICATION ==========
    document.addEventListener('DOMContentLoaded', init);

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      stopBackgroundMusic();
      stopAllNatureSounds();
      if (audioContext) {
        audioContext.close();
      }
    });
  </script>
</body>
</html>
